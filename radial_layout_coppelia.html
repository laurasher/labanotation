<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	
	<!-- D3.js -->
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script> -->
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<!-- <script src="d3-scale-radial.js"></script> -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js" integrity="sha512-csNcFYJniKjJxRWRV1R7fvnXrycHP6qDR21mgz1ZP55xY5d+aHLfo9/FcGDQLfn2IfngbAHd8LdfsagcCqgTcQ==" crossorigin="anonymous"></script>
	<!-- Google Font -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400" rel='stylesheet' type='text/css'>
		
	<style>
		body {
		  	font-size: 10px;
		  	font-family: 'Open Sans', sans-serif;
		  	font-weight: 400;
		  	fill: #8C8C8C;
		  	text-align: center;
		  	background: #F8E8CB;
		}

	  	.title {
	    	font-size: 28px;
	    	fill: #4F4F4F;
	    	font-weight: 300;
	    	text-anchor: start;
	  	}

	  	.subtitle {
	    	font-size: 14px;
	    	fill: #AAAAAA;
	    	font-weight: 300;
	    	text-anchor: start;
	  	}
	  
	  	.credit {
	    	font-size: 12px;
	    	fill: #AAAAAA;
	    	font-weight: 300;
	    	text-anchor: start;
	  	}

	  	.axis path,
	  	.axis tick,
	  	.axis line {
	      	fill: none;
	      	stroke: none;
	  	}

	  	.axis text {
	      	font-size: 12px;
	      	fill: #AAAAAA;
	      	font-weight: 400;
	  	}

	  	.axisText {
	  		fill: #C4C4C4;
	  		font-size: 11px;
	  		font-weight: 300;
	  		text-anchor: middle;
	  		text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
	  		display: none;
	  	}

	  	.axisCircles {
	  		fill: none;
	  		stroke: black;
	  		stroke-width: 0.5px;
	  		opacity: 0.2;
	  		display: none;
	  	}
	  	.axisSpokes {
	  		fill: none;
	  		stroke: black;
	  		stroke-width: 0.5px;
	  		opacity: 0.2;
	  		display: none;
	  	}
	  	button:focus {outline:0;}
	  	.body-button{
	  		/*background: white;*/
	  		border-radius: 3px;
	  		background: transparent;
			color: black;
			border: 1px solid black;
			padding: 5px;
	  	}
	  	.enabled{
	  		background: white;
	  	}
	</style>

	
</head>	
<body>
	<button id="head-button" class="body-button">head</button>
	<button id="arm-button" class="body-button">arm</button>
	<button id="hand-button" class="body-button">hand</button>
	<button id="leg-button" class="body-button">leg</button>
	<button id="body-button" class="body-button">body</button>
	<button id="foot-button" class="body-button">foot</button>
	<button id="all-button" class="body-button enabled">all</button>
	<div id="choreoRadial"></div>
	<script>


		function saveSvg(svg, name){
	        var svg_data = document.getElementById("choreoRadial").innerHTML //put id of your svg element here
	        var head = '<svg title="graph" version="1.1" xmlns="http://www.w3.org/2000/svg">'
	        //if you have some additional styling like graph edges put them inside <style> tag
	        // var style = '<style>circle {cursor: pointer;stroke-width: 1.5px;}text {font: 10px arial;}path {stroke: DimGrey;stroke-width: 1.5px;}</style>'
	        var full_svg = head +  style + svg_data + "</svg>"
	        var blob = new Blob([full_svg], {type: "image/svg+xml"});  
	        saveAs(blob, name);

		};
		function bodyButtonOnClick(body_part, radialWrapper, dataStyling, svg, dataArr, lineRadial){
			console.log(body_part);
			$('.body-button').removeClass('enabled')
			$('#'+body_part+'-button').addClass('enabled')
			radialWrapper.remove()
			radialWrapper = svg.append("g")
				.attr("transform", "translate(" + 0 + "," + 0 + ")");
			for (i = 0; i < dataArr.length; i++) {
				if (dataStyling[i].body_movement == body_part){
					className = "radial_"+dataStyling[i].body_movement
					radialWrapper
					    .append("path")
					    .attr("d", lineRadial(dataArr[i].data))
					    .attr("class", className)
					    .attr("opacity", function(d,i) { return className.includes(body_part) ? 0.7 : 0 })
					    .attr("fill", "none")
					    .attr("stroke-width", function(d,i) { return className.includes(body_part) ? radialLineWidth/2 : radialLineWidth/2 })
					    .attr("stroke", function(d,i) { return className.includes(body_part) ? "black" : "black" })
				}
			}
			let alignRotate = -44;
		    radialWrapper.attr("transform", function(d,i) { return "rotate(" + ( alignRotate ) + ")"; })
		    saveSvg(svg, ballet+'_'+body_part+'.svg')
		}
		///////////////////////////////////////////////////////////////////////////
		//////////////////////////////// Data files ///////////////////////////////
		///////////////////////////////////////////////////////////////////////////	

		const datapath = "bbox_output/"
		var stepCircleColor = "black"
		var stepCircleAlpha = 0.3
		var barWidth = 10
		var barHeightMulitplier = 200
		var dataset; // global
		var numRadialSpokes = 8
		var randJitter = false
		var lineRes = 0.005
		var radialLineWidth = 0.5
		// var lineRes = 0.005/5
		// var radialLineWidth = 0.1

		function getRandomNumber(start, end) {
	        return (Math.random() * (end-start) * 100)/100 + start;
	    }
	    function degrees_to_radians(degrees) {
		  var pi = Math.PI;
		  return degrees * (pi/180);
		}
		function radians_to_degrees(rad) {
		  var pi = Math.PI;
		  return rad * (180/pi);
		}
		var ballet = 'coppelia_dawn'
		d3.json(datapath+ballet+".json", function(data) {
		    dataset = data;
		    // dataset = dataset.filter(x=>x.direction_movement=='backward_diagonal')
			var spokeArr = d3.range(0,359,359/numRadialSpokes)
			var spokeArrRad = spokeArr.map(x => degrees_to_radians(x))
			var bodyMovements = [
									"head",
									"right_hand",
									"right_arm",
									"right_body",
									"right_leg",
									"right_support",
									"left_support",
									"left_leg",
									"left_body",
									"left_arm",
									"left_hand"
								]

			///////////////////////////////////////////////////////////////////////////
			//////////////////// Set up and initiate svg containers ///////////////////
			///////////////////////////////////////////////////////////////////////////	

			var margin = {
				top: 70,
				right: 20,
				bottom: 120,
				left: 20
			};
			var width = window.innerWidth - margin.left - margin.right - 20;
			var height = window.innerHeight - margin.top - margin.bottom - 20;

			//SVG container
			var svg = d3.select("#choreoRadial")
				.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + (margin.left + width/2) + "," + (margin.top + height/2) + ")");

			///////////////////////////////////////////////////////////////////////////
			//////////////////////////// Create scales ////////////////////////////////
			///////////////////////////////////////////////////////////////////////////

			function staffNumToRad(staff_num){
				return parseInt(staff_num);
			}
			function bodyMovementToTheta(body_movement){
				switch(body_movement){
					case "right_arm":
						return spokeArr[2];
					case "left_arm":
						return spokeArr[9];
					case "right_leg":
						return spokeArr[4];
					case "left_leg":
						return spokeArr[7];
					case "right_support":
						return spokeArr[5];
					case "left_support":
						return spokeArr[6];
					case "right_hand":
						return spokeArr[1];
					case "left_hand":
						return spokeArr[10];
					case "right_body":
						return spokeArr[3];
					case "left_body":
						return spokeArr[8];
					case "head":
						return spokeArr[0];
				}
			}

			function bodyDirectionToTheta(body_movement, direction){
				switch(direction){
					case "place":
						return;
					case "forward":
						return spokeArr[0]
					case "forward_diagonal":
						if (body_movement.includes("right")){
							return spokeArr[1]
						} else {
							return spokeArr[7]
						}
					case "right":
						return spokeArr[2];
					case "backward_diagonal":
						if (body_movement.includes("right")){
							return spokeArr[3]
						} else {
							return spokeArr[5]
						}
					case "backward":
						return spokeArr[4];
					case "left":
						return spokeArr[6];
				}
			}

			// staff_num corresponds to R, radius
			dataset.forEach(function(d) {
				d.rad = staffNumToRad(d.staff_num) 
				// + getRandomNumber(0.1,0.5);
			});

			// body_movement corresponds to THETA, pin to a spoke at a certain theta val
			dataset.forEach(function(d) {
				// d.theta = bodyMovementToTheta(d.body_movement) + 50
				d.theta = bodyDirectionToTheta(d.body_movement, d.direction_movement) + 50
				// d.thetaRad = degrees_to_radians( bodyMovementToTheta(d.body_movement) + 50 )
				d.thetaRad = degrees_to_radians( bodyDirectionToTheta(d.body_movement, d.direction_movement) + 50 )
			});


			//Set the minimum inner radius and max outer radius of the chart
			var	outerRadius = Math.min(width, height, 250)/2,
				innerRadius = outerRadius * 0.4;

			//Base the color scale on average temperature extremes
			var colorScale = d3.scaleLinear()
				.domain([1, 8])
				.range(["#2c7bb6", "#ffff8c", "#d7191c"])
				.interpolate(d3.interpolateHcl);

			//Scale for the heights of the bar, not starting at zero to give the bars an initial offset outward
			var barScale = d3.scaleLinear()
				.range([innerRadius, outerRadius])
				.domain([1,8]);  


			///////////////////////////////////////////////////////////////////////////
			//////////////////////////// Radial line //////////////////////////////////
			///////////////////////////////////////////////////////////////////////////

			var dataArr = []
			var data = []
			var dataStyling = []

			radArr = dataset.map(x=>(x.ymin * x.staff_num)/25)
			function findClosest(num, spoke){
				if (Math.abs(num[0] - spoke) <= 0.03) return 1
			}
			for (ii = 0; ii < radArr.length; ii++) {
				if(dataset[ii].body_movement!=null){
					// if(dataset[ii].body_movement.includes("arm")){
					data = []
					for (i = 0; i <= 2; i=i+lineRes) {
					  data.push([Math.PI * i, radArr[ii] + getRandomNumber(-0.5, 0.5) ])
					}
					dataStyling.push({'body_movement' : dataset[ii].body_movement, 'step_length' : dataset[ii].step_length})
					arr = spokeArrRad
					num = degrees_to_radians(dataset[ii].theta)
					var closestSpoke = arr.reduce(function(prev, curr) {
				  		return (Math.abs(curr - num) < Math.abs(prev - num) ? curr : prev);
					});
					
					// find theta closest to chosen spokeArr
					index = data.findIndex(x => findClosest(x, closestSpoke));
					data[index] = [data[index][0], radArr[ii] + dataset[ii].step_length * 300]
					// for (j=0; j<=2; j++){
					// 	data[index-j] = [data[index][0], radArr[ii] + (dataset[ii].step_length * (160 - 2.5*j))]
					// 	data[index+j] = [data[index][0], radArr[ii] + (dataset[ii].step_length * (160 - 2.5*j))]
					// }
					dataArr.push({data})
				}
			}

			var lineRadial = d3.lineRadial();
			var radialWrapper = svg.append("g")
				.attr("transform", "translate(" + 0 + "," + 0 + ")");
			var highlight = "leg"

			for (i = 0; i < dataArr.length; i++) {
				className = "radial_"+dataStyling[i].body_movement
				curRadialLineWidth = dataStyling[i].step_length
				radialWrapper
				    .append("path")
				    .attr("d", lineRadial(dataArr[i].data))
				    .attr("class", className)
				    .attr("opacity", stepCircleAlpha)
				    .attr("fill", "none")
				    // .attr("stroke-width", curRadialLineWidth*30 )
				    .attr("stroke-width", radialLineWidth )
				    .attr("stroke", "black")
			}

			var alignRotate = -44;
		    radialWrapper.attr("transform", function(d,i) { return "rotate(" + ( alignRotate ) + ")"; })

			////////////////////////////////////////////// buttons //////////////////////////////////////////////
			$("#head-button").click(function(){bodyButtonOnClick('head', radialWrapper, dataStyling, svg, dataArr, lineRadial)});
			$('#arm-button').click(function(){bodyButtonOnClick('arm', radialWrapper, dataStyling, svg, dataArr, lineRadial)});
			$('#leg-button').click(function(){bodyButtonOnClick('leg', radialWrapper, dataStyling, svg, dataArr, lineRadial)});
			$('#foot-button').click(function(){bodyButtonOnClick('foot', radialWrapper, dataStyling, svg, dataArr, lineRadial)});
			$('#body-button').click(function(){bodyButtonOnClick('body', radialWrapper, dataStyling, svg, dataArr, lineRadial)})
			$('#hand-button').click(function(){bodyButtonOnClick('hand', radialWrapper, dataStyling, svg, dataArr, lineRadial)})
			$('#all-button').click(function(){
				console.log("ALL");
				$('.body-button').removeClass('enabled')
				$('#all-button').addClass('enabled')
				radialWrapper.remove()
				radialWrapper = svg.append("g")
					.attr("transform", "translate(" + 0 + "," + 0 + ")");
				for (i = 0; i < dataArr.length; i++) {
					className = "radial_"+dataStyling[i].body_movement
					radialWrapper
					    .append("path")
					    .attr("d", lineRadial(dataArr[i].data))
					    .attr("class", className)
					    .attr("opacity", 0.6)
					    .attr("fill", "none")
					    .attr("stroke-width", radialLineWidth/3)
					    .attr("stroke", "black");
				}
		    	radialWrapper.attr("transform", function(d,i) { return "rotate(" + ( alignRotate ) + ")"; })
		    	saveSvg(svg, ballet+'_ALL.svg')
			});

		});
	</script>

</script>

</body>
</html>